---
title: "è®¡ç®—æœºç½‘ç»œåŸºç¡€"
date: 2025-06-17
categories: ["Network"]
tags: ["Gloassary"]
excerpt: "è¿‘æœŸåœ¨ä¸€äº›å¸¸è§çš„è®¡ç®—æœºç½‘ç»œé¢è¯•é—®é¢˜ã€‚"
mermaid: true
---

# 0x01 è®¡ç®—æœºç½‘ç»œåŸºç¡€

## 1. TCP ä¸‰æ¬¡æ¡æ‰‹ä¸å››æ¬¡æŒ¥æ‰‹

TCP æ•°æ®åŒ…å¤´éƒ¨å…± 20 å­—èŠ‚ï¼Œç»“æ„å‚è€ƒä¸‹å›¾ï¼š

<figure style="text-align: center;">
    <img src="/assets/images/posts/20250617/tcp_header.png" alt="tcp_header" width="750" height="210">
    <figcaption>TCP Header</figcaption>
</figure>

- 0-4   å­—èŠ‚ï¼šSrcIP / DstIP
- 5-8   å­—èŠ‚ï¼š**Sequence Number**
- 9-12  å­—èŠ‚ï¼š**Acknowledge Number**
- 13-16 å­—èŠ‚ï¼š
  - 13-14 å­—èŠ‚ï¼š4 offset + 6 Reserved Data + 6 **Signal**
  - 15-16 å­—èŠ‚ï¼šWindow å¤§å°
- 17-20 å­—èŠ‚ï¼š
  - 17-18 å­—èŠ‚ï¼šæ ¡éªŒå’Œ
  - 19-20 å­—èŠ‚ï¼šç´§æ€¥æŒ‡é’ˆ

13-14 byte çš„æœ€å 6 bit ä¸ºä¿¡å·æ ‡å¿—ä½ï¼Œå…¶ä¸­å°±åŒ…æ‹¬ SYNã€ACKã€FIN æ ‡å¿—ä½ã€‚

æ„å»º TCP è¿æ¥æ—¶ï¼Œä¸‰æ¬¡æ¡æ‰‹é¡ºåºå¦‚ä¸‹ï¼ŒClient å’Œ Server éƒ½ä¼šå‡ºä¸€ä¸ªéšæœºçš„ **Sequence Number**ï¼ŒACK ä¸­è¿”å› seq+1 ä½œä¸º ACK ç¼–ç ã€‚

```mermaid
sequenceDiagram
  Client->>Server: SYN
  Server->>Client: SYN+ACK
  Client->>Server: ACK
```

### Why Not

> Client å‘é€çš„ç¬¬ä¸€ä¸ªè¿æ¥è¯·æ±‚ SYN1 å› ç½‘ç»œå»¶è¿Ÿè€Œæ»ç•™ï¼Œäºæ˜¯ Client é‡å‘äº†ç¬¬äºŒä¸ªè¯·æ±‚ SYN2 å¹¶æˆåŠŸå»ºç«‹äº†è¿æ¥ï¼Œæ•°æ®ä¼ è¾“å®Œæ¯•åè¿æ¥è¢«é‡Šæ”¾ã€‚æ­¤æ—¶ï¼Œå»¶è¿Ÿçš„ SYN1 æ‰åˆ°è¾¾ Client...

å››æ¬¡æŒ¥æ‰‹è¿‡ç¨‹å¦‚ä¸‹ï¼š

```mermaid
sequenceDiagram
  Client->>Server: FIN
  activate Client
  participant Client
  Note left of Client: FIN-WAIT-1
  Server->>Client: ACK
  deactivate Client
  participant Client
  Note left of Client: FIN-WAIT-2
  Server->>Client: FIN
  activate Server
  participant Server
  Note right of Server: LAST-ACK
  Client->>Server: ACK
  deactivate Server
  Note left of Client: TIME-WAIT(2MSL)
  Note right of Server: CLOSE
  Note left of Client: CLOSE
```

å› ä¸º TCP æ˜¯**å…¨åŒå·¥æ¨¡å¼è¿æ¥**ï¼Œæ‰€ä»¥åŒæ–¹éœ€å„è‡ªé‡Šæ”¾è¿æ¥ã€‚

### Why Not

> ç¬¬å››æ¬¡æŒ¥æ‰‹æ—¶ï¼Œå®¢æˆ·ç«¯å‘é€ç»™æœåŠ¡ç«¯çš„ ACK æœ‰å¯èƒ½ä¸¢å¤±ï¼Œå¦‚æœæœåŠ¡ç«¯å› ä¸ºæŸäº›åŸå› è€Œæ²¡æœ‰æ”¶åˆ° ACK çš„è¯ï¼ŒæœåŠ¡ç«¯å°±ä¼šé‡å‘ FINï¼Œå¦‚æœå®¢æˆ·ç«¯åœ¨ 2*MSL çš„æ—¶é—´å†…æ”¶åˆ°äº† FINï¼Œå°±ä¼šé‡æ–°å‘é€ ACK å¹¶å†æ¬¡ç­‰å¾… 2MSLï¼Œé˜²æ­¢ Server æ²¡æœ‰æ”¶åˆ° ACK è€Œä¸æ–­é‡å‘ FIN...

## 2. TCP å’Œ UDP ç‰¹ç‚¹å’Œé€‚ç”¨åœºæ™¯

åè®®  æ˜¯å¦è¿æ¥    æ˜¯å¦å¯é     é€‚ç”¨åœºæ™¯
TCP æœ‰è¿æ¥ï¼ˆä¸‰æ¬¡æ¡æ‰‹ï¼‰   æœ‰åº+é‡ä¼ +æ‹¥å¡æ§åˆ¶  Webã€æ–‡ä»¶ä¼ è¾“
UDP æ— è¿æ¥ ä¸å¯é ï¼Œæ— é‡ä¼  è§†é¢‘ã€è¯­éŸ³ã€DNSã€DHCP

## 3. ä»€ä¹ˆæ˜¯MTU, MSS, Window Scaling, Nagle's algorithm

- MTUï¼ˆæœ€å¤§ä¼ è¾“å•å…ƒï¼‰ï¼šä»¥å¤ªç½‘ä¸€èˆ¬ä¸º 1500 bytesã€‚
- MSSï¼ˆæœ€å¤§æŠ¥æ–‡æ®µï¼‰ï¼šTCP å±‚çš„æ•°æ®å¤§å°ï¼Œçº¦ä¸º MTU - 40ã€‚
- Window Scalingï¼šTCPçª—å£æ”¾å¤§ï¼Œæ”¯æŒé«˜å¸¦å®½å»¶è¿Ÿç½‘ç»œã€‚
- Nagle ç®—æ³•ï¼šåˆå¹¶å°åŒ…å‘é€ï¼Œé™ä½æ‹¥å¡ï¼Œå»¶è¿Ÿæ›´é«˜ã€‚

## 4. ç®€è¿° DNS åŸç†ï¼Œé€’å½’ vs è¿­ä»£æŸ¥è¯¢

- é€’å½’æŸ¥è¯¢
  - å®¢æˆ·ç«¯ â†’ æœ¬åœ° DNS
  - è¯·æ±‚æµç¨‹ï¼šå®¢æˆ·ç«¯åªå‘ **ä¸€æ¬¡è¯·æ±‚**ï¼Œè¦æ±‚å¯¹æ–¹ç»™å‡ºæœ€ç»ˆç»“æœã€‚ç”± **æœ¬åœ°åŸŸåæœåŠ¡å™¨ (Local DNS)** ä¸€å£æ°”æŸ¥åˆ°æœ€ç»ˆ IP å¹¶è¿”å›ã€‚
  - è¿”å›ç»“æœï¼šæŸ¥è¯¢æˆåŠŸæˆ–æŸ¥è¯¢å¤±è´¥ã€‚
- è¿­ä»£æŸ¥è¯¢ï¼š
  - å®¢æˆ·ç«¯ â†’ æœ¬åœ°DNS/å‘æ ¹ã€å®¢æˆ·ç«¯ â†’ TLDã€å®¢æˆ·ç«¯ â†’ æƒå¨DNS
  - è¯·æ±‚æµç¨‹ï¼šå®¢æˆ·ç«¯å‘å‡º **å¤šæ¬¡è¯·æ±‚**ï¼Œå¯¹æ–¹å¦‚æœæ²¡æœ‰æˆæƒå›ç­”ï¼Œå®ƒå°±ä¼šè¿”å›ä¸€ä¸ªèƒ½è§£ç­”è¿™ä¸ªæŸ¥è¯¢çš„å…¶å®ƒåç§°**æœåŠ¡å™¨åˆ—è¡¨**ã€‚å®¢æˆ·ç«¯ä¼šå†å‘è¿”å›çš„åˆ—è¡¨ä¸­å‘å‡ºè¯·æ±‚ï¼Œç›´åˆ°æ‰¾åˆ°æœ€ç»ˆè´Ÿè´£æ‰€æŸ¥åŸŸåçš„åç§°æœåŠ¡å™¨ï¼Œä»å®ƒå¾—åˆ°æœ€ç»ˆç»“æœã€‚
  - è¿”å›ç»“æœï¼šæœ€ä½³çš„æŸ¥è¯¢ç‚¹ æˆ– ä¸»æœºåœ°å€ã€‚

```mermaid
sequenceDiagram
    autonumber
    participant Client as å®¢æˆ·ç«¯
    participant LDNS as æœ¬åœ°DNSè§£æå™¨
    participant Root as æ ¹DNSæœåŠ¡å™¨
    participant TLD as é¡¶çº§åŸŸDNSï¼ˆ.com / .cnï¼‰
    participant Auth as æƒå¨DNSæœåŠ¡å™¨

    %% é€’å½’æŸ¥è¯¢è·¯å¾„
    rect rgb(240,240,255)
    Note over Client,LDNS: ğŸŒ€ é€’å½’æŸ¥è¯¢ï¼ˆæœ¬åœ°DNSæ›¿å®¢æˆ·ç«¯å®Œæˆæ‰€æœ‰æŸ¥è¯¢ï¼‰
    Client->>LDNS: è¯·æ±‚ www.example.com çš„ IPï¼ˆé€’å½’æŸ¥è¯¢ï¼‰
    LDNS->>Root: è¯¢é—®æ ¹æœåŠ¡å™¨ï¼ˆ.com åœ¨å“ªï¼Ÿï¼‰
    Root-->>LDNS: è¿”å› .com é¡¶çº§åŸŸçš„åœ°å€
    LDNS->>TLD: è¯¢é—® .com åŸŸï¼ˆexample.com åœ¨å“ªï¼Ÿï¼‰
    TLD-->>LDNS: è¿”å› example.com çš„æƒå¨DNSåœ°å€
    LDNS->>Auth: è¯¢é—® example.com æƒå¨DNS
    Auth-->>LDNS: è¿”å› www.example.com çš„ IP
    LDNS-->>Client: è¿”å›æœ€ç»ˆ IP åœ°å€
    end

    %% è¿­ä»£æŸ¥è¯¢è·¯å¾„
    rect rgb(255,250,230)
    Note over Client,Auth: ğŸ” è¿­ä»£æŸ¥è¯¢ï¼ˆDNSæœåŠ¡å™¨ä»…è¿”å›ä¸‹ä¸€è·³ï¼‰
    Client->>Root: ç›´æ¥è¯¢é—®æ ¹DNSï¼ˆwww.example.comï¼‰
    Root-->>Client: å‘Šè¯‰ä½  .com é¡¶çº§åŸŸDNSåœ¨å“ª
    Client->>TLD: ç»§ç»­è¯¢é—® .com DNS
    TLD-->>Client: å‘Šè¯‰ä½  example.com æƒå¨DNSåœ¨å“ª
    Client->>Auth: æœ€åè¯¢é—®æƒå¨DNS
    Auth-->>Client: è¿”å› www.example.com çš„ IP
    end
```

## Q5. ä»€ä¹ˆæ˜¯ ARP, DHCP, NAT, VLAN, å­ç½‘åˆ’åˆ†

- ARPï¼šIP â†’ MAC æ˜ å°„ï¼ŒäºŒå±‚é€šä¿¡ã€‚
- DHCPï¼šåŠ¨æ€åˆ†é…IPåœ°å€ã€‚
- NATï¼šç§ç½‘ â†’ å…¬ç½‘åœ°å€è½¬æ¢ã€‚
- VLANï¼šé€»è¾‘éš”ç¦»äºŒå±‚å¹¿æ’­åŸŸã€‚
- å­ç½‘åˆ’åˆ†ï¼šCIDR è®°æ³•ï¼ˆå¦‚ 192.168.1.0/24ï¼‰æ§åˆ¶ä¸»æœºæ•°ä¸ç½‘ç»œè§„æ¨¡ã€‚

# 0x02 ç½‘ç»œæ€§èƒ½ä¸è°ƒä¼˜

## 6. Linux ä¸‹å¦‚ä½•æŸ¥çœ‹ç½‘ç»œè¿æ¥å’Œå»¶è¿Ÿ

- `ss -tuna` / `netstat -anp`ï¼šæŸ¥çœ‹TCP/UDPè¿æ¥
- `ping`ï¼šICMPå¾€è¿”å»¶è¿Ÿï¼ˆRTTï¼‰
- `traceroute`ï¼šæ¯ä¸€è·³å»¶è¿Ÿ
- `iperf3`ï¼šTCP/UDP ååæµ‹è¯•
- `tcpdump`ï¼šæŠ“åŒ…åˆ†æï¼ˆè¿‡æ»¤å¦‚ `tcp port 80`ï¼‰

## 7. å¦‚ä½•æ’æŸ¥é«˜ RTT æˆå› ã€ä¸¢åŒ…ç°è±¡ï¼Œä»¥åŠç½‘ç»œæ‹¥å¡æƒ…å†µï¼Ÿ

- `ping` çœ‹æ³¢åŠ¨ & ä¸¢åŒ…
- `traceroute` å®šä½å¼‚å¸¸å‡ºç°åœ¨å“ªè·³è¿æ¥
- `iperf` ç¡®è®¤å¯¹ç«¯ååæ˜¯å¦æ­£å¸¸
- `tcpdump` ç¡®è®¤ TCP æ•°æ®åŒ…ä¸­å‚æ•°æƒ…å†µï¼Œç€é‡çœ‹é‡ä¼ æ¬¡æ•°ã€çª—å£å¤§å°

**æŒ‡æ ‡å…³æ³¨**ï¼š

- RTT å¤§ â†’ æ‹¥å¡æˆ–é“¾è·¯å»¶è¿Ÿ
- ä¸¢åŒ…é«˜ â†’ é“¾è·¯è´¨é‡å·® or buffer æº¢å‡º
- çª—å£å° â†’ æ»åäº BDPï¼Œéœ€ window scaling

## 8. ç®€è¿° TCP æ‹¥å¡æ§åˆ¶å››é˜¶æ®µå’Œå†…å®¹

- **æ…¢å¯åŠ¨ï¼ˆSlow Startï¼‰**ï¼šåˆæœŸæŒ‡æ•°å¢é•¿ cwndï¼Œæ”¶åˆ°ä¸€ä¸ªackå¢åŠ ä¸€ä¸ªæ–°çª—å£ã€‚åˆå§‹æ‹¥å¡çª—å£ï¼ˆcwndï¼‰ä¸€èˆ¬ä¸º 1~10 ä¸ª MSSï¼Œæ¯æ”¶åˆ°ä¸€ä¸ª ACKï¼Œ**çª—å£åŠ å€**ï¼ˆæŒ‡æ•°å¢é•¿ï¼‰ï¼Œå¿«é€Ÿæ¢æµ‹å¸¦å®½ï¼Œä½†é£é™©é«˜ã€‚
- **æ‹¥å¡é¿å…**ï¼šçº¿æ€§å¢é•¿ cwndã€‚å½“ cwnd â‰¥ ssthreshï¼ˆæ…¢å¯åŠ¨é˜ˆå€¼ï¼‰æ—¶ï¼Œè¿›å…¥æ‹¥å¡é¿å…ã€‚æ¯ RTT å¢é•¿**çº¿æ€§**ï¼ˆæ¯è½® +1 MSSï¼‰ï¼Œç¨³å¥ä½†å¢é•¿æ…¢ã€‚
- **å¿«é‡ä¼ **ï¼šæ”¶åˆ°3ä¸ªé‡å¤ACKï¼Œç«‹å³é‡ä¼ ã€‚ä¸ç­‰è¶…æ—¶ï¼Œè‹¥æ”¶åˆ°æ¥æ”¶æ–¹ **3 ä¸ªé‡å¤ ACK**ï¼ˆè¯´æ˜æŸä¸ªåŒ…ä¸¢äº†ï¼‰ã€‚ç«‹å³é‡å‘ä¸¢å¤±çš„æ•°æ®åŒ…ã€‚
- **å¿«æ¢å¤**ï¼šå‡åŠ cwndï¼Œè¿›å…¥æ‹¥å¡é¿å…è€Œéé‡å¤´æ¥ã€‚å¿«é‡ä¼ åï¼Œè¯´æ˜ç½‘ç»œå¯ç”¨ï¼Œä½†æœ‰æ‹¥å¡ã€‚é¿å… cwnd é€€å› 1ï¼Œå‡å°‘æ€§èƒ½æŸå¤±ã€‚è°ƒæ•´ç­–ç•¥å¯ä»¥ç”¨ä¼ªä»£ç è¡¨è¿°ï¼š
  - ssthresh = cwnd / 2
  - cwnd = ssthreshï¼ˆæˆ– ssthresh + 3ï¼‰
  - è¿›å…¥**æ‹¥å¡é¿å…é˜¶æ®µ**è€Œä¸æ˜¯é‡å›æ…¢å¯åŠ¨

# 0x03 é«˜é¢‘äº¤æ˜“ä¸­é«˜æ€§èƒ½ç½‘ç»œä¼˜åŒ–

## 9. ä»€ä¹ˆæ˜¯ busy-polling å’Œ DPDK

**busy-polling**ï¼šCPUè½®è¯¢æ”¶åŒ…ï¼Œè·³è¿‡ä¸­æ–­ï¼Œæé«˜ä½å»¶è¿Ÿèƒ½åŠ›ï¼ˆå¯ç”¨ `SO_BUSY_POLL`ï¼‰

**DPDKï¼ˆData Plane Development Kitï¼‰**ï¼š

- ç”¨æˆ·æ€ç»•è¿‡å†…æ ¸åè®®æ ˆ
- é›¶æ‹·è´ + å¤šæ ¸å¹¶å‘ + é«˜åå
- é€‚ç”¨äºé«˜é¢‘äº¤æ˜“ã€SDN

## 10. é«˜é¢‘äº¤æ˜“ç½‘ç»œä¸­çš„å»¶è¿Ÿä¼šå‡ºç°åœ¨å“ªäº›ç¯èŠ‚ï¼Ÿ

```mermaid
sequenceDiagram
    autonumber
    participant UA as ç”¨æˆ·åº”ç”¨ï¼ˆUser Spaceï¼‰
    participant K as ç³»ç»Ÿå†…æ ¸ï¼ˆKernelï¼‰
    participant NIC as é©±åŠ¨ / ç½‘å¡ï¼ˆDriver & NICï¼‰
    participant L as ç‰©ç†é“¾è·¯ï¼ˆå…‰çº¤/é“œç¼†ï¼‰
    participant SR as äº¤æ¢/è·¯ç”±è®¾å¤‡ï¼ˆä¸­é—´èŠ‚ç‚¹ï¼Œè‹¥å¤šè·³å¯ç†è§£ä¸ºå¤šå°ï¼‰
    participant RNIC as è¿œç«¯ç½‘å¡
    participant RK as è¿œç«¯å†…æ ¸
    participant RA as è¿œç«¯åº”ç”¨

    UA->>K: send()/write() ç­‰ç³»ç»Ÿè°ƒç”¨
    Note over UA,K: [A] ç³»ç»Ÿå±‚çº§å»¶è¿Ÿï¼šç”¨æˆ·æ€â†’å†…æ ¸æ€åˆ‡æ¢ã€ç¼“å†²æ‹·è´ç­‰

    K->>K: TCP/IP åè®®æ ˆå¤„ç†
    Note right of K: [B] å†…æ ¸å±‚çº§å»¶è¿Ÿï¼šTCP/IP åˆ†æ®µã€æ‹¥å¡/æµæ§ã€è·¯ç”±æŸ¥æ‰¾ã€æ ¡éªŒç­‰

    K->>NIC: æŠ¥æ–‡ä¸‹å‘åˆ°é©±åŠ¨/NIC
    Note over K,NIC: [C] é©±åŠ¨/NIC å»¶è¿Ÿï¼šé©±åŠ¨æ’é˜Ÿã€DMAã€NIC ç¡¬ä»¶é˜Ÿåˆ—/è°ƒåº¦

    NIC->>L: æ¯”ç‰¹ä¸Šçº¿
    Note right of L: [D1] ç‰©ç†ä¼ æ’­å»¶è¿Ÿï¼šâ‰ˆ 5 Î¼s / kmï¼ˆå…‰çº¤ï¼‰

    L->>SR: å…¥äº¤æ¢/è·¯ç”±è®¾å¤‡
    SR->>SR: è®¾å¤‡å¤„ç†/è½¬å‘
    Note right of SR: [D2] äº¤æ¢/è·¯ç”±å¤„ç†ï¼šæŸ¥è¡¨ã€é˜Ÿåˆ—è°ƒåº¦ã€ACL/QoS ç­‰

    SR-->>SR: æ’é˜Ÿç­‰å¾…ï¼ˆçªå‘/æ‹¥å¡æ—¶ï¼‰
    Note right of SR: [D3] æ’é˜Ÿå»¶è¿Ÿï¼ˆBufferbloatï¼‰

    SR->>L: å‡ºå£ç«¯å£å‘å‡º
    Note right of L: [D1] ç»§ç»­ä¼ æ’­ï¼ˆè‹¥å¤šè·³åˆ™é‡å¤ D1/D2/D3ï¼‰

    L->>RNIC: åˆ°è¾¾è¿œç«¯ç½‘å¡
    RNIC->>RK: DMA ä¸Šé€/ä¸­æ–­
    Note over RNIC,RK: [C]ï¼ˆå¯¹ç§°ï¼‰è¿œç«¯é©±åŠ¨/NIC å»¶è¿Ÿ

    RK->>RK: è¿œç«¯ TCP/IP åè®®æ ˆå¤„ç†
    Note right of RK: [B]ï¼ˆå¯¹ç§°ï¼‰è¿œç«¯å†…æ ¸åè®®æ ˆå»¶è¿Ÿ

    RK->>RA: é€’äº¤åˆ°è¿œç«¯åº”ç”¨
    Note over RK,RA: [A]ï¼ˆå¯¹ç§°ï¼‰å†…æ ¸â†’ç”¨æˆ·æ€äº¤ä»˜
```

1. ç³»ç»Ÿå±‚çº§ï¼šç”¨æˆ·ç©ºé—´ â†’ ç³»ç»Ÿå†…æ ¸è°ƒç”¨å»¶è¿Ÿ
2. å†…æ ¸å±‚çº§ï¼šå†…æ ¸åè®®æ ˆå¤„ç†å»¶è¿Ÿï¼Œæ¥æºäº TCP å’Œ IP åè®®å¤„ç†
3. é©±åŠ¨å±‚çº§ï¼šç¡¬ä»¶é©±åŠ¨å±‚ â†’ ç½‘å¡ï¼ˆNICï¼‰å»¶è¿Ÿ
4. ç‰©ç†å±‚çº§ï¼š
  - å…‰çº¤å»¶è¿Ÿçº¦ 5 Î¼s/km
  - äº¤æ¢/è·¯ç”±å™¨å¤„ç†
  - æ•°æ®åŒ…æ’é˜Ÿå»¶è¿Ÿï¼ˆBufferbloatï¼‰

## 11. é«˜é¢‘äº¤æ˜“ç½‘ç»œä¸­å¯ä»¥é‡‡ç”¨å“ªäº›æ–¹æ¡ˆä¼˜åŒ–å»¶è¿Ÿï¼Ÿ

ä¸Šé¢æåˆ°çš„å»¶è¿Ÿï¼Œæ¯ä¸ªé˜¶æ®µéƒ½æœ‰ä¼˜åŒ–ç­–ç•¥ï¼Œ

> ç»‘å®š CPU core**
> - **å…³é—­ Nagle**
> - **ç”¨ `SO_RCVBUF` / `SO_SNDBUF` è°ƒæ•´ buffer**

---

## Reference

- [TCP 3-Way Handshake Process](https://medium.com/@kusal95/tcp-3-way-handshake-process-1fd9a056a2f4)
- [TCP ä¸‰æ¬¡æ¡æ‰‹å’Œå››æ¬¡æŒ¥æ‰‹ï¼ˆä¼ è¾“å±‚ï¼‰](https://javaguide.cn/cs-basics/network/tcp-connection-and-disconnection.html)